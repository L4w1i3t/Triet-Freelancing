<IfModule mod_headers.c>
    # Prevent Clickjacking
    Header always set X-Frame-Options "DENY"

    # Prevent MIME sniffing
    Header set X-Content-Type-Options "nosniff"

    # Enable XSS protection in older browsers
    Header set X-XSS-Protection "1; mode=block"

    # Enforce a comprehensive Content Security Policy (CSP) for commission site
    Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.paypal.com https://js.stripe.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.emailjs.com https://api.paypal.com https://api.stripe.com; frame-src https://www.paypal.com https://js.stripe.com; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;"

    # Control what gets sent in the Referer header
    Header set Referrer-Policy "strict-origin-when-cross-origin"

    # Restrict access to browser features for commission site
    Header set Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), usb=(), serial=(), bluetooth=()"

    # Enable HSTS (HTTP Strict Transport Security) - use with HTTPS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Prevent DNS prefetching to improve privacy
    Header set X-DNS-Prefetch-Control "off"
</IfModule>

# Rate Limiting for API endpoints and forms
<IfModule mod_evasive.c>
    DOSHashTableSize 4096
    DOSPageCount 3
    DOSPageInterval 1
    DOSSiteCount 50
    DOSSiteInterval 1
    DOSBlockingPeriod 600
</IfModule>

# Disable directory listing
Options -Indexes

# Block access to sensitive files
<FilesMatch "(\.htaccess|\.htpasswd|\.log|\.sql|\.json|\.config)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Block requests containing suspicious characters and patterns
RewriteEngine On

# Block XSS attempts
RewriteCond %{QUERY_STRING} (<|>|%3C|%3E|script|%3Cscript%3E|javascript|vbscript|onload|onerror) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block SQL injection attempts
RewriteCond %{QUERY_STRING} (union|select|insert|drop|delete|update|create|alter|exec|execute) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block file injection attempts
RewriteCond %{QUERY_STRING} (\.\.\/|\.\.\\|\/etc\/passwd|\/proc\/|boot\.ini) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block common exploit attempts
RewriteCond %{QUERY_STRING} (eval\(|base64_decode|php://|file_get_contents|curl|wget) [NC]
RewriteRule ^(.*)$ - [F,L]

# Block bot and malicious user agents
RewriteCond %{HTTP_USER_AGENT} (bot|crawler|spider|scraper|curl|wget|python|perl|java) [NC]
RewriteCond %{HTTP_USER_AGENT} !(googlebot|bingbot|slurp|duckduckbot|facebookexternalhit) [NC]
RewriteRule ^(.*)$ - [F,L]

# Disable ETags to prevent information leakage
FileETag None

# Set security headers for specific file types
<FilesMatch "\.(html|htm|php)$">
    Header set X-Frame-Options "DENY"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
</FilesMatch>

# Ensure correct MIME types for JavaScript files
<FilesMatch "\.(js)$">
    Header set Content-Type "application/javascript; charset=utf-8"
</FilesMatch>

# Force correct MIME type for admin.js specifically
<Files "admin.js">
    ForceType application/javascript
    Header set Content-Type "application/javascript; charset=utf-8"
</Files>

# Disable server signature
ServerSignature Off

# Limit request size to prevent DoS attacks (10MB limit)
LimitRequestBody 10485760

# Protect against protocol attacks
RewriteCond %{THE_REQUEST} !^[A-Z]{3,9}\ /.*\ HTTP/ [NC]
RewriteRule .* - [F,L]

# Block suspicious POST requests
RewriteCond %{REQUEST_METHOD} POST
RewriteCond %{HTTP_CONTENT_TYPE} !^(application/x-www-form-urlencoded|multipart/form-data|application/json) [NC]
RewriteRule .* - [F,L]
FileETag None
Header unset ETag

